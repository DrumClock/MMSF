[manual_stepper manual_0]
step_pin: MMSF:PD15
dir_pin:  MMSF:PA1
enable_pin:  !MMSF:PA3
microsteps: 16
rotation_distance: 24
velocity: 5
accel:  0
endstop_pin: ^MMSF:PB2


[tmc2209 manual_stepper manual_0]	
uart_pin:  MMSF:PD8
run_current: 0.800
stealthchop_threshold: 500


#########################################################################################

[gcode_macro MANUAL_LOAD]
gcode:  
       SET_SERVO SERVO=switching_0  angle=55
       G4 P500  
       SET_SERVO SERVO=switching_0   WIDTH=0
       G4 P300 

#-----------------------------------------------------------------------------------------------------

     {% set act_extruder = printer.toolhead.extruder %}   
     
     {% set nozzle_switch  = 120|int   %}  ; nozzle - switch distance in mm
     {% set switch_park  = 80|int   %}   ; switch - parkinng distance in mm
     {% set speed  = 30|int   %}   ;mm/s
     
     {% set max_extrude = printer.configfile.settings[(act_extruder)].max_extrude_only_distance|int %}  
     {% set step = (nozzle_switch) // max_extrude|int %}
     {% set rest = (nozzle_switch) % max_extrude|float %} 
     

    ### load filament to end_stop switch      
       MANUAL_STEPPER STEPPER=manual_0  ENABLE=1
       MANUAL_STEPPER STEPPER=manual_0  SET_POSITION=0  MOVE={switch_park + 10}  SPEED={speed}  STOP_ON_ENDSTOP=-1
       
    ### load filament to extruder   
       MANUAL_STEPPER STEPPER=manual_0  SET_POSITION=0  MOVE={nozzle_switch}  SPEED={speed}   SYNC=0
       M83
       G92 E0                
        {% for n in range(step) %}
          G1 E{max_extrude} F{speed*60} 
        {% endfor %}	
        {% if rest > 0.0 %}
          G1 E{rest} F{speed*60}
        {% endif %}  
       M400
             
       MANUAL_STEPPER STEPPER=manual_0  ENABLE=0
#-----------------------------------------------------------------------------------------------------

       SET_SERVO SERVO=switching_0  angle=100
       G4 P300  
       SET_SERVO SERVO=switching_0   WIDTH=0
       G4 P300 

######################################################################################
       
[gcode_macro MANUAL_UNLOAD]
gcode:  
       SET_SERVO SERVO=switching_0  angle=55
       G4 P500 
       SET_SERVO SERVO=switching_0   WIDTH=0
       G4 P300 
       
#-----------------------------------------------------------------------------------------------------
     {% set act_extruder = printer.toolhead.extruder %}  
     
     {% set nozzle_switch  = 120|int   %}  ; nozzle - switch distance in mm
     {% set switch_park  = 80|int   %}   ; switch - parkinng distance in mm
     {% set speed  = 30|int   %}   ;mm/s
     
     {% set max_extrude = printer.configfile.settings[(act_extruder)].max_extrude_only_distance|int %}  
     {% set step = (nozzle_switch*0.7)|int // max_extrude|int %}
     {% set rest = (nozzle_switch*0.7) % max_extrude|float %} 
     
       ### unload filament from extruder
       MANUAL_STEPPER STEPPER=manual_0  ENABLE=1
       MANUAL_STEPPER STEPPER=manual_0  SET_POSITION=0  MOVE=-{nozzle_switch*0.7}  SPEED={speed}  SYNC=0  
       M83
       G92 E0                
        {% for n in range(step) %}
          G1 E-{max_extrude} F{speed*60}
        {% endfor %}	
        {% if rest > 0.0 %}
          G1 E-{rest} F{speed*60}
        {% endif %}  
       M400
       
       ### unload filament to end_stop pin
       MANUAL_STEPPER STEPPER=manual_0  SET_POSITION=0  MOVE=-{nozzle_switch*0.4}  SPEED={speed}  STOP_ON_ENDSTOP=1   
       ### unload filament to park position
       MANUAL_STEPPER STEPPER=manual_0  SET_POSITION=0  MOVE=-{switch_park}   SPEED={speed}      
       MANUAL_STEPPER STEPPER=manual_0  ENABLE=0
       
#-----------------------------------------------------------------------------------------------------
 
       SET_SERVO SERVO=switching_0  angle=100
       G4 P300  
       SET_SERVO SERVO=switching_0   WIDTH=0
       G4 P300 

#############################################################################
#############################################################################
#############################################################################


[gcode_macro MANUAL_TEST]
gcode:  

       SET_SERVO SERVO=switching_0  angle=55
       G4 P500  
       SET_SERVO SERVO=switching_0   WIDTH=0
       G4 P300 

     {% set act_extruder = printer.toolhead.extruder %} 
     {% set max_extrude = printer.configfile.settings[(act_extruder)].max_extrude_only_distance|int %} 
     
     {% set nozzle_switch  = 120|int   %}  ; nozzle - switch distance in mm
     {% set switch_park  = 80|int   %}   ; switch - parkinng distance in mm
     {% set speed  = 30|int   %}   ;mm/s
    

    {% for x in range(params.LOOP|default(1)|int) %}
    
     {% set msg = ("Loop: %s" % loop.index) %} 
     {% if printer.configfile.config['display'] %}   M117 {msg}   {% endif %}  
     RESPOND MSG='{msg}'
    
#-------------------LOAD --------------------------------------

     {% set step = (nozzle_switch) // max_extrude|int %}
     {% set rest = (nozzle_switch) % max_extrude|float %} 
     
    ### load filament to end_stop switch      
       MANUAL_STEPPER STEPPER=manual_0  ENABLE=1
       MANUAL_STEPPER STEPPER=manual_0  SET_POSITION=0  MOVE={switch_park + 10}  SPEED={speed}  STOP_ON_ENDSTOP=-1
       
    ### load filament to extruder   
       MANUAL_STEPPER STEPPER=manual_0  SET_POSITION=0  MOVE={nozzle_switch}  SPEED={speed}   SYNC=0
       M83
       G92 E0                
        {% for n in range(step) %}
          G1 E{max_extrude} F{speed*60} 
        {% endfor %}	
        {% if rest > 0.0 %}
          G1 E{rest} F{speed*60}
        {% endif %}  
       M400
             
       MANUAL_STEPPER STEPPER=manual_0  ENABLE=0

       G4 P1000
#---------------- UNLOAD -----------------------------------------

     {% set step = (nozzle_switch*0.7)|int // max_extrude|int %}
     {% set rest = (nozzle_switch*0.7) % max_extrude|float %} 
     
         ### unload filament from extruder
       MANUAL_STEPPER STEPPER=manual_0  ENABLE=1
       MANUAL_STEPPER STEPPER=manual_0  SET_POSITION=0  MOVE=-{nozzle_switch*0.7}  SPEED={speed}  SYNC=0  
       M83
       G92 E0                
        {% for n in range(step) %}
          G1 E-{max_extrude} F{speed*60}
        {% endfor %}	
        {% if rest > 0.0 %}
          G1 E-{rest} F{speed*60}
        {% endif %}  
       M400
       
       ### unload filament to end_stop pin
       MANUAL_STEPPER STEPPER=manual_0  SET_POSITION=0  MOVE=-{nozzle_switch*0.4}  SPEED={speed}  STOP_ON_ENDSTOP=1   
       ### unload filament to park position
       MANUAL_STEPPER STEPPER=manual_0  SET_POSITION=0  MOVE=-{switch_park}   SPEED={speed}      
       MANUAL_STEPPER STEPPER=manual_0  ENABLE=0

      G4 P1000
      
#----------------------- END ----------------------------------
 {% endfor %}
 
       SET_SERVO SERVO=switching_0  angle=100
       G4 P300  
       SET_SERVO SERVO=switching_0   WIDTH=0
       G4 P300 